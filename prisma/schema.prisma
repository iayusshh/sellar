// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  CREATOR
  BUYER
  ADMIN
}

enum ProductType {
  DIGITAL
  SESSION
  TELEGRAM
}

enum ProductStatus {
  DRAFT
  ACTIVE
  DISABLED
}

enum DeliveryMethod {
  FILE
  LINK
  NONE
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum WalletTransactionType {
  CREDIT_SALE
  DEBIT_PAYOUT
  ADJUSTMENT
}

enum WalletTransactionStatus {
  PENDING
  AVAILABLE
  REVERSED
}

enum PayoutStatus {
  REQUESTED
  APPROVED
  PAID
  REJECTED
  CANCELLED
}

model User {
  id            String   @id @default(cuid())
  name          String?
  email         String?  @unique
  emailVerified DateTime?
  image         String?

  passwordHash    String?
  role            Role      @default(BUYER)
  phone           String?
  phoneVerifiedAt DateTime?

  creatorProfile CreatorProfile?
  products       Product[]
  ordersAsBuyer  Order[]   @relation("BuyerOrders")
  ordersAsCreator Order[]  @relation("CreatorOrders")
  wallet         Wallet?
  payoutRequests PayoutRequest[]
  analyticsEvents AnalyticsEvent[] @relation("AnalyticsActor")
  phoneOtps      PhoneOtp[]

  accounts Account[]
  sessions Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CreatorProfile {
  id              String  @id @default(cuid())
  userId          String  @unique
  user            User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  slug            String  @unique
  displayName     String
  bio             String?
  isStorefrontLive Boolean @default(true)

  payoutBankName        String?
  payoutBankAccountLast4 String?
  payoutBankIfsc        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id          String        @id @default(cuid())
  creatorId   String
  creator     User          @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  type        ProductType   @default(DIGITAL)
  status      ProductStatus @default(DRAFT)

  slug        String
  name        String
  description String
  terms       String?

  currency        String @default("INR")
  priceCents      Int
  discountPercent Int?

  validityDays Int?

  supplyLimit Int?
  supplySold  Int @default(0)

  deliveryMethod   DeliveryMethod @default(NONE)
  deliveryAssetUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orderItems OrderItem[]

  @@unique([creatorId, slug])
}

model Order {
  id        String      @id @default(cuid())
  status    OrderStatus @default(PENDING)

  buyerId   String
  buyer     User        @relation("BuyerOrders", fields: [buyerId], references: [id], onDelete: Restrict)

  creatorId String
  creator   User        @relation("CreatorOrders", fields: [creatorId], references: [id], onDelete: Restrict)

  buyerName  String
  buyerEmail String
  buyerPhone String

  currency String @default("INR")

  amountSubtotalCents Int
  amountTotalCents    Int
  platformFeeCents    Int
  creatorNetCents     Int

  stripeCheckoutSessionId String? @unique
  stripePaymentIntentId   String?

  items  OrderItem[]
  walletTransactions WalletTransaction[]

  paidAt    DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  quantity       Int @default(1)
  unitPriceCents Int
  totalCents     Int

  productNameSnapshot String

  createdAt DateTime @default(now())
}

model Wallet {
  id                   String @id @default(cuid())
  creatorId             String @unique
  creator               User   @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  currency              String @default("INR")
  availableBalanceCents Int    @default(0)
  pendingBalanceCents   Int    @default(0)
  totalPaidOutCents     Int    @default(0)

  transactions WalletTransaction[]
  payoutRequests PayoutRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WalletTransaction {
  id        String                 @id @default(cuid())
  walletId  String
  wallet    Wallet                 @relation(fields: [walletId], references: [id], onDelete: Cascade)

  type      WalletTransactionType
  status    WalletTransactionStatus @default(AVAILABLE)

  // Positive amounts credit the wallet; negative amounts debit.
  amountCents Int
  description String?

  orderId String?
  order   Order? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  payoutRequestId String?
  payoutRequest   PayoutRequest? @relation(fields: [payoutRequestId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([walletId, createdAt])
}

model PayoutRequest {
  id        String      @id @default(cuid())
  status    PayoutStatus @default(REQUESTED)

  creatorId String
  creator   User        @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  walletId  String
  wallet    Wallet      @relation(fields: [walletId], references: [id], onDelete: Cascade)

  amountCents Int
  currency    String @default("INR")

  bankAccountLast4 String?
  bankName         String?

  processedAt DateTime?
  adminNote   String?

  transactions WalletTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AnalyticsEvent {
  id      String @id @default(cuid())
  kind    String
  data    Json

  actorUserId String?
  actorUser   User? @relation("AnalyticsActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
}

model PhoneOtp {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  phone     String
  codeHash  String
  expiresAt DateTime
  consumedAt DateTime?
  createdAt DateTime @default(now())

  @@index([userId, phone])
}

// NextAuth / Auth.js models
model Account {
  id                String  @id @default(cuid())
  userId            String
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
